{% extends 'base.html' %}
{% load static %}
{% load humanize %}

{% block title %}
  {% if search_query %}
    Search: {{ search_query }} - Afrimart
  {% else %}
    All Products - Afrimart
  {% endif %}
{% endblock %}

{% block content %}
<div class="container my-5 py-3">
  <!-- Breadcrumb -->
  <nav aria-label="breadcrumb" class="mb-4">
    <ol class="breadcrumb mb-0">
      <li class="breadcrumb-item"><a href="{% url 'home' %}" class="text-decoration-none text-muted small">Home</a></li>
      <li class="breadcrumb-item active small text-dark fw-bold">
        {% if search_query %}Search Results{% else %}All Products{% endif %}
      </li>
    </ol>
  </nav>

  <!-- Header & Search -->
  <div class="row align-items-end border-bottom pb-4 mb-5">
    <div class="col-md-6 mb-3 mb-md-0">
      <h1 class="fw-bold h2 mb-0" style="letter-spacing: -1px;">
        {% if search_query %}
          Search Results
        {% else %}
          All Products
        {% endif %}
      </h1>
      <p class="text-muted small mb-0">
        {% if search_query %}
          Showing results for "{{ search_query }}"
        {% else %}
          Discover amazing products from verified sellers
        {% endif %}
      </p>
    </div>
    <div class="col-md-6">
      <!-- Search Form -->
      <form method="get" action="{% url 'product_list' %}" class="d-flex">
        <input type="text" 
               name="search" 
               class="form-control form-control-lg bg-light border-0 me-2" 
               placeholder="Search products..."
               value="{{ search_query }}"
               style="font-size: 14px;">
        <button type="submit" class="btn btn-dark text-uppercase fw-bold px-4" style="font-size: 13px; letter-spacing: 1px;">
          <ion-icon name="search-outline" class="align-middle"></ion-icon>
          Search
        </button>
      </form>
    </div>
  </div>

  <!-- Filters & Sort Bar -->
  <div class="row align-items-center mb-4 pb-3 border-bottom">
    <div class="col-md-6">
      <p class="mb-0 small text-muted">
        <strong>{{ products.count }}</strong> product{{ products.count|pluralize }} found
      </p>
    </div>
    <div class="col-md-6 text-md-end">
      <form method="get" class="d-inline-block">
    
        <label class="x-small text-muted text-uppercase fw-bold me-2">Sort By:</label>
        <select name="sort" class="form-select form-select-sm d-inline-block w-auto border-0 bg-light" onchange="this.form.submit()" style="font-size: 13px;">
          <option value="-created_at" {% if sort_by == '-created_at' %}selected{% endif %}>Newest First</option>
          <option value="name" {% if sort_by == 'name' %}selected{% endif %}>Name (A-Z)</option>
          <option value="price_low" {% if sort_by == 'price_low' %}selected{% endif %}>Price: Low to High</option>
          <option value="price_high" {% if sort_by == 'price_high' %}selected{% endif %}>Price: High to Low</option>
        </select>
      </form>
    </div>
  </div>

  {% if products %}
    <!-- Products Grid -->
    <div class="row g-4">
      {% for product in products %}
      <div class="col-6 col-md-4 col-lg-3">
        <div class="product-card border bg-white h-100 d-flex flex-column">
          <!-- Product Image -->
          <a href="{% url 'product_detail' product.id %}" class="text-decoration-none">
            <div class="product-image border-bottom" style="height: 250px; overflow: hidden; position: relative;">
              {% if product.get_primary_image %}
                <img src="{{ product.get_primary_image }}" 
                     alt="{{ product.name }}" 
                     class="w-100 h-100 object-fit-cover">
              {% else %}
                <div class="w-100 h-100 bg-light d-flex align-items-center justify-content-center">
                  <ion-icon name="image-outline" style="font-size: 48px; color: #ddd;"></ion-icon>
                </div>
              {% endif %}

              <!-- Badges -->
              {% if product.has_discount %}
                <span class="badge bg-danger position-absolute top-0 start-0 m-2" style="font-size: 11px;">
                  -{{ product.discount_percentage }}%
                </span>
              {% endif %}

              {% if product.is_featured %}
                <span class="badge position-absolute top-0 end-0 m-2" style="background-color: var(--primary-green); font-size: 10px;">
                  FEATURED
                </span>
              {% endif %}

              {% if product.stock <= 5 and product.stock > 0 %}
                <span class="badge bg-warning text-dark position-absolute bottom-0 start-0 m-2" style="font-size: 10px;">
                  Only {{ product.stock }} left
                </span>
              {% endif %}
            </div>
          </a>

          <!-- Product Info -->
          <div class="p-3 flex-grow-1 d-flex flex-column">
            <a href="{% url 'product_detail' product.id %}" class="text-decoration-none text-dark">
              <h6 class="fw-bold mb-2" style="font-size: 14px; line-height: 1.4;">
                {{ product.name|truncatechars:50 }}
              </h6>
            </a>

            <!-- Price -->
            <div class="mb-3 mt-auto">
              {% if product.has_discount %}
                <p class="mb-0">
                  <span class="text-success fw-bold" style="font-size: 18px;">
                    ₦{{ product.get_discounted_price|floatformat:2|intcomma }}
                  </span>
                  <span class="text-muted text-decoration-line-through small ms-1">
                    ₦{{ product.price|floatformat:2|intcomma }}
                  </span>
                </p>
                <p class="x-small text-success mb-0">
                  Save ₦{{ product.get_savings|floatformat:2|intcomma }}
                </p>
              {% else %}
                <p class="mb-0">
                  <span class="text-success fw-bold" style="font-size: 18px;">
                    ₦{{ product.price|floatformat:2|intcomma }}
                  </span>
                </p>
              {% endif %}
            </div>

            <!-- Seller -->
            {% if product.seller %}
              <p class="x-small text-muted mb-3">
                <ion-icon name="storefront-outline" class="align-middle"></ion-icon>
                {{ product.seller.username }}
              </p>
            {% endif %}

            <!-- Add to Cart Button -->
            <form method="post" action="{% url 'add_to_cart' product.id %}" class="mt-auto">
              {% csrf_token %}
              <input type="hidden" name="quantity" value="1">
              <button type="submit" 
                      class="btn w-100 text-white text-uppercase fw-bold border-0 py-2" 
                      style="background-color: var(--primary-green); font-size: 12px; letter-spacing: 0.5px;"
                      {% if product.stock <= 0 %}disabled{% endif %}>
                {% if product.stock <= 0 %}
                  <ion-icon name="close-circle-outline" class="align-middle me-1"></ion-icon>
                  Out of Stock
                {% else %}
                  <ion-icon name="cart-outline" class="align-middle me-1"></ion-icon>
                  Add to Bag
                {% endif %}
              </button>
            </form>
          </div>
        </div>
      </div>
      {% endfor %}
    </div>

  {% else %}
    <!-- Empty State -->
    <div class="text-center py-5 my-5">
      <div class="mb-4">
        <ion-icon name="search-outline" style="font-size: 80px; color: #ddd;"></ion-icon>
      </div>
      <h3 class="fw-bold mb-3">No Products Found</h3>
      <p class="text-muted mb-4">
        {% if search_query %}
          We couldn't find any products matching "{{ search_query }}"
        {% else %}
          No products available at the moment.
        {% endif %}
      </p>
      <div class="d-flex gap-3 justify-content-center flex-wrap">
        {% if search_query %}
          <a href="{% url 'product_list' %}" class="btn btn-outline-dark text-uppercase fw-bold px-4">
            Clear Search
          </a>
        {% endif %}
        <a href="{% url 'home' %}" class="btn text-white text-uppercase fw-bold border-0 px-4" style="background-color: var(--primary-green);">
          Browse All Products
        </a>
      </div>
    </div>
  {% endif %}
</div>

<style>
  .x-small { font-size: 11px; }
  
  .product-card {
    transition: transform 0.2s, box-shadow 0.2s;
  }

  .product-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 10px 30px rgba(0,0,0,0.1);
  }

  .product-image img {
    transition: transform 0.3s;
  }

  .product-card:hover .product-image img {
    transform: scale(1.05);
  }

  .object-fit-cover {
    object-fit: cover;
  }

  .border, .btn, .badge, .form-control, .form-select {
    border-radius: 0 !important;
  }

  .form-control:focus, .form-select:focus {
    border-color: var(--primary-green);
    box-shadow: none;
  }

  
  @media (max-width: 768px) {
    .product-image {
      height: 200px !important;
    }
  }
</style>

<script>
  
  document.addEventListener('DOMContentLoaded', function() {
    const sortSelect = document.querySelector('select[name="sort"]');
    if (sortSelect) {
      sortSelect.addEventListener('change', function() {
        this.form.submit();
      });
    }
  });
</script>
{% endblock %}