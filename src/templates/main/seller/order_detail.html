{% extends "base.html" %}
{% load static %}
{% load currency_tags %}
{% load humanize %}

{% block title %}Order Details #{{ order.id }} - Afrimart{% endblock %}

{% block content %}
<div class="container my-5 py-3">
    <nav aria-label="breadcrumb" class="mb-4">
        <ol class="breadcrumb mb-0">
            <li class="breadcrumb-item"><a href="{% url 'seller_orders' %}" class="text-decoration-none text-muted small">My Orders</a></li>
            <li class="breadcrumb-item active small text-dark fw-bold" aria-current="page">Invoice #{{ order.id }}</li>
        </ol>
    </nav>

    <div class="row align-items-end border-bottom pb-4 mb-5 g-4">
        <div class="col-md-6 text-center text-md-start">
            <h1 class="fw-bold h2 mb-0" style="letter-spacing: -1px;">Order #{{ order.id }}</h1>
            <p class="text-muted small mb-0">Placed on {{ order.created_at|date:"M d, Y" }} at {{ order.created_at|date:"H:i" }}</p>
        </div>
        <div class="col-md-6 text-center text-md-end">
            <div class="d-flex justify-content-center justify-content-md-end gap-2">
                <button class="btn btn-outline-dark px-4 py-2 text-uppercase fw-bold shadow-none" style="font-size: 11px; letter-spacing: 1px;">
                    <ion-icon name="print-outline" class="me-2 align-middle"></ion-icon> Print Invoice
                </button>
            </div>
        </div>
    </div>

    <div class="row g-5">
        <div class="col-lg-8">
            <div class="row g-4 mb-5">
                <div class="col-md-6">
                    <div class="p-4 border bg-white h-100">
                        <h6 class="x-small fw-bold text-uppercase text-muted mb-3" style="letter-spacing: 1px;">Fulfillment Status</h6>
                        {% if order.status == 'pending' %}
                            <span class="badge bg-warning text-dark px-3 py-2 text-uppercase fw-bold" style="font-size: 10px;">Pending</span>
                        {% elif order.status == 'processing' %}
                            <span class="badge bg-info text-white px-3 py-2 text-uppercase fw-bold" style="font-size: 10px;">Processing</span>
                        {% elif order.status == 'shipped' %}
                            <span class="badge bg-secondary text-white px-3 py-2 text-uppercase fw-bold" style="font-size: 10px;">Shipped</span>
                        {% elif order.status == 'delivered' %}
                            <span class="badge px-3 py-2 text-uppercase fw-bold" style="background-color: var(--primary-green); color:#fff; font-size: 10px;">Delivered</span>
                        {% elif order.status == 'cancelled' %}
                            <span class="badge bg-danger text-white px-3 py-2 text-uppercase fw-bold" style="font-size: 10px;">Cancelled</span>
                        {% endif %}
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="p-4 border bg-white h-100">
                        <h6 class="x-small fw-bold text-uppercase text-muted mb-3" style="letter-spacing: 1px;">Payment Settlement</h6>
                        {% if order.payment_status == 'pending' %}
                            <span class="badge bg-warning text-dark px-3 py-2 text-uppercase fw-bold" style="font-size: 10px;">Awaiting Funds</span>
                        {% elif order.payment_status == 'paid' %}
                            <span class="badge px-3 py-2 text-uppercase fw-bold" style="background-color: var(--primary-green); color:#fff; font-size: 10px;">Paid & Secured</span>
                        {% elif order.payment_status == 'failed' %}
                            <span class="badge bg-danger text-white px-3 py-2 text-uppercase fw-bold" style="font-size: 10px;">Failed</span>
                        {% elif order.payment_status == 'refunded' %}
                            <span class="badge bg-info text-white px-3 py-2 text-uppercase fw-bold" style="font-size: 10px;">Refunded</span>
                        {% endif %}
                    </div>
                </div>
            </div>

            <div class="mb-5">
                <h5 class="fw-bold text-uppercase mb-4" style="font-size: 13px; letter-spacing: 1px;">Item Manifest</h5>
                <div class="table-responsive">
                    <table class="table align-middle border bg-white">
                        <thead class="bg-light">
                            <tr class="x-small fw-bold text-uppercase text-muted">
                                <th class="border-0 px-3 py-3">Product Name</th>
                                <th class="border-0 py-3 text-center">Qty</th>
                                <th class="border-0 py-3">Unit Price</th>
                                <th class="border-0 py-3 text-end pe-3">Subtotal</th>
                            </tr>
                        </thead>
                        <tbody class="small fw-semibold">
                            {% for item in order.items.all %}
                                <tr>
                                    <td class="px-3 py-4">
                                        <a href="{% url 'product_detail' item.product.id %}" class="text-decoration-none text-dark hover-green">
                                            {{ item.product.name }}
                                        </a>
                                    </td>
                                    <td class="text-center">{{ item.quantity }}</td>
                                    <td>₦{{ item.price|floatformat:2 }}</td>
                                    <td class="text-end pe-3">₦{{ item.get_total|floatformat:2 }}</td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="p-4 border bg-white">
                <h5 class="fw-bold text-uppercase mb-4" style="font-size: 13px; letter-spacing: 1px;">Delivery Intelligence</h5>
                <div class="row g-4">
                    <div class="col-md-7">
                        <p class="x-small fw-bold text-uppercase text-muted mb-2">Shipping Address</p>
                        <p class="small text-dark mb-0" style="line-height: 1.8;">{{ order.shipping_address|linebreaksbr }}</p>
                    </div>
                    <div class="col-md-5">
                        <p class="x-small fw-bold text-uppercase text-muted mb-2">Tracking Logistics</p>
                        {% if order.tracking_number %}
                            <code class="d-block p-2 bg-light border text-dark fw-bold mb-2">{{ order.tracking_number }}</code>
                            <span class="extra-small text-muted text-uppercase">Standard Carrier</span>
                        {% else %}
                            <p class="small text-muted italic mb-0">No tracking number assigned yet.</p>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <div class="col-lg-4">
            <div class="p-4 border bg-white mb-4">
                <h6 class="fw-bold text-uppercase mb-4 border-bottom pb-3" style="font-size: 12px; letter-spacing: 1px;">Client Profile</h6>
                <div class="d-flex align-items-center mb-3">
                    <div class="bg-light text-success fw-bold d-flex align-items-center justify-content-center me-3" style="width:45px; height:45px; font-size: 18px;">
                        {{ order.buyer.username|slice:":1"|upper }}
                    </div>
                    <div>
                        <h6 class="mb-0 fw-bold small text-dark">{{ order.buyer.get_full_name|default:order.buyer.username }}</h6>
                        <a href="mailto:{{ order.buyer.email }}" class="extra-small text-muted text-decoration-none hover-green">{{ order.buyer.email }}</a>
                    </div>
                </div>
                {% if order.buyer.profile.phone %}
                    <div class="pt-3 border-top d-flex align-items-center gap-2">
                        <ion-icon name="call-outline" class="text-success"></ion-icon>
                        <span class="small fw-bold">{{ order.buyer.profile.get_display_phone }}</span>
                    </div>
                {% endif %}
            </div>

            <div class="p-4 border bg-white">
                <h6 class="fw-bold text-uppercase mb-4 border-bottom pb-3" style="font-size: 12px; letter-spacing: 1px;">Financial Recap</h6>
                <div class="d-flex justify-content-between mb-3">
                    <span class="text-muted small">Subtotal</span>
                    <span class="fw-bold small">₦{{ order.total_amount|floatformat:2 }}</span>
                </div>
                {% if order.total_amount_usd %}
                <div class="d-flex justify-content-between mb-3">
                    <span class="text-muted small">USD Equiv.</span>
                    <span class="fw-bold small text-muted">${{ order.total_amount_usd|floatformat:2 }}</span>
                </div>
                {% endif %}
                <div class="d-flex justify-content-between align-items-center mt-4 pt-3 border-top">
                    <span class="h6 fw-bold mb-0 text-uppercase">Total Yield</span>
                    <span class="h4 fw-bold mb-0 text-success">₦{{ order.total_amount|floatformat:2 }}</span>
                </div>
                <p class="extra-small text-muted mt-3 mb-0">Settled in {{ order.currency }}</p>
            </div>

            <div class="p-4 border bg-light mt-4">
                <h6 class="x-small fw-bold text-uppercase text-muted mb-3">Transaction Audit</h6>
                <div class="mb-3">
                    <p class="extra-small text-muted text-uppercase mb-1 fw-bold">Method</p>
                    {% for payment in order.payments.all %}
                        <span class="small fw-bold text-dark d-block mb-1">{{ payment.get_payment_method_display|default:payment.payment_method }}</span>
                        <code class="extra-small text-muted">{{ payment.reference }}</code>
                    {% empty %}
                        <span class="small text-muted italic">Awaiting settlement details</span>
                    {% endfor %}
                </div>
                <div class="pt-2 border-top">
                    <p class="extra-small text-muted mb-1"><strong>Audit Logged:</strong> {{ order.created_at|date:"M d, Y H:i" }}</p>
                    <p class="extra-small text-muted m-0"><strong>Last Sync:</strong> {{ order.updated_at|date:"M d, Y H:i" }}</p>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    /* Industrial UI Identity Resets */
    .btn, .border, .bg-light, .badge, .table, .bg-white { border-radius: 0 !important; }
    .x-small { font-size: 11px; }
    .extra-small { font-size: 10px; }

    .hover-green:hover { color: var(--primary-green) !important; transition: 0.2s; }
    
    .table td, .table th { border-color: #eee; }
    .bg-light { background-color: #f8f8f8 !important; }
</style>
{% endblock %}