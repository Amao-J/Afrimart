{% extends 'base.html' %}
{% load static %}
{% load currency_tags %}
{% load humanize %}

{% block title %}Checkout - Afrimart Marketplace{% endblock %}

{% block content %}

<div class="container my-5 py-3">
  <nav aria-label="breadcrumb" class="mb-4">
    <ol class="breadcrumb mb-0">
      <li class="breadcrumb-item"><a href="{% url 'home' %}" class="text-decoration-none text-muted small">Home</a></li>
      <li class="breadcrumb-item"><a href="{% url 'view_cart' %}" class="text-decoration-none text-muted small">Bag</a></li>
      <li class="breadcrumb-item active small text-dark fw-bold">Checkout</li>
    </ol>
  </nav>

  <div class="row align-items-end border-bottom pb-4 mb-5 g-4">
    <div class="col-md-4">
        <h1 class="fw-bold h2 mb-0" style="letter-spacing: -1px;">Secure Checkout</h1>
        <p class="text-muted small mb-0">Step 2 of 3: Shipping & Payment</p>
    </div>
    <div class="col-md-8">
        <div class="d-flex justify-content-md-end gap-2 gap-md-4">
            <div class="d-flex align-items-center opacity-50">
                <span class="x-small fw-bold text-uppercase border rounded-circle d-flex align-items-center justify-content-center me-2" style="width:20px; height:20px; font-size:9px;">1</span>
                <span class="x-small fw-bold text-uppercase text-nowrap">Bag</span>
            </div>
            <div class="d-flex align-items-center text-success">
                <span class="x-small fw-bold text-uppercase border border-success rounded-circle d-flex align-items-center justify-content-center me-2" style="width:20px; height:20px; font-size:9px; background: var(--primary-green); color:#fff;">2</span>
                <span class="x-small fw-bold text-uppercase text-nowrap">Information</span>
            </div>
            <div class="d-flex align-items-center opacity-25">
                <span class="x-small fw-bold text-uppercase border rounded-circle d-flex align-items-center justify-content-center me-2" style="width:20px; height:20px; font-size:9px;">3</span>
                <span class="x-small fw-bold text-uppercase text-nowrap">Payment</span>
            </div>
        </div>
    </div>
  </div>

  <form method="POST" id="checkoutForm">
    {% csrf_token %}
    
    <div class="row g-5">
      <div class="col-lg-7">
        
        <div class="mb-5">
            <h5 class="fw-bold text-uppercase mb-4" style="font-size: 13px; letter-spacing: 1px;">1. Shipping Destination</h5>
            <div class="row g-3">
              <div class="col-md-6">
                <label class="form-label x-small fw-bold text-uppercase text-muted">First Name</label>
                <input type="text" class="form-control form-control-lg bg-light border-0" name="first_name" value="{{ user.first_name }}" required>
              </div>
              <div class="col-md-6">
                <label class="form-label x-small fw-bold text-uppercase text-muted">Last Name</label>
                <input type="text" class="form-control form-control-lg bg-light border-0" name="last_name" value="{{ user.last_name }}" required>
              </div>
              <div class="col-12">
                <label class="form-label x-small fw-bold text-uppercase text-muted">Email Address</label>
                <input type="email" class="form-control form-control-lg bg-light border-0" name="email" value="{{ user.email }}" required>
              </div>
              <div class="col-12">
                <label class="form-label x-small fw-bold text-uppercase text-muted">Street Address</label>
                <textarea name="shipping_address" class="form-control bg-light border-0" rows="2" placeholder="House number and street name" required>{{ request.POST.shipping_address|default:'' }}</textarea>
              </div>
              <div class="col-md-6">
                <label class="form-label x-small fw-bold text-uppercase text-muted">City</label>
                <input type="text" class="form-control form-control-lg bg-light border-0" name="shipping_city" required>
              </div>
              <div class="col-md-6">
                <label class="form-label x-small fw-bold text-uppercase text-muted">Country</label>
                <select class="form-select form-select-lg bg-light border-0" name="country" required>
                  <option value="NG" selected>Nigeria</option>
                  <option value="GH">Ghana</option>
                  <option value="KE">Kenya</option>
                  <option value="ZA">South Africa</option>
                </select>
              </div>
              <div class="col-12">
                <div class="form-check mt-2">
                  <input class="form-check-input" type="checkbox" id="saveAddress" name="save_address">
                  <label class="form-check-label x-small fw-bold text-muted text-uppercase" for="saveAddress">Save address to profile</label>
                </div>
              </div>
            </div>
        </div>

        <div class="mb-5">
            <h5 class="fw-bold text-uppercase mb-4" style="font-size: 13px; letter-spacing: 1px;">2. Shipping Method</h5>
            <div class="d-grid gap-3">
                <label class="method-select-card p-3 border d-flex justify-content-between align-items-center cursor-pointer">
                    <div class="d-flex align-items-center">
                        <input class="form-check-input me-3" type="radio" name="shipping_method" value="standard" checked>
                        <div>
                            <span class="d-block fw-bold small">Standard Shipping</span>
                            <span class="x-small text-muted">5-7 business days</span>
                        </div>
                    </div>
                    <span class="text-success fw-bold small">FREE</span>
                </label>
                
                <label class="method-select-card p-3 border d-flex justify-content-between align-items-center cursor-pointer">
                    <div class="d-flex align-items-center">
                        <input class="form-check-input me-3" type="radio" name="shipping_method" value="express">
                        <div>
                            <span class="d-block fw-bold small">Express Priority</span>
                            <span class="x-small text-muted">2-3 business days</span>
                        </div>
                    </div>
                    <span class="fw-bold small">₦5,000</span>
                </label>
            </div>
        </div>

        <div class="mb-5">
            <h5 class="fw-bold text-uppercase mb-4" style="font-size: 13px; letter-spacing: 1px;">3. Payment Secure Gateway</h5>
            <div class="border bg-white">
               
                <div class="p-3 border-bottom bg-light">
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="payment_method" id="escrowPayment" value="escrow" checked>
                        <label class="form-check-label fw-bold small" for="escrowPayment">
                            <ion-icon name="shield-checkmark" class="text-success align-middle me-1"></ion-icon>
                            Escrow Payment
                        </label>
                    </div>
                    <div id="escrowDetails" class="mt-3 px-3">
                        <div class="alert alert-success border-0 mb-0" style="background-color: #f0f9f4;">
                            <h6 class="fw-bold small mb-2">
                                <ion-icon name="information-circle" class="align-middle me-1"></ion-icon>
                                What is Escrow Payment?
                            </h6>
                            <ul class="x-small mb-0 ps-3">
                                <li>Your money is held securely until you confirm delivery</li>
                                <li>Seller gets paid only after you're satisfied</li>
                                <li>100% buyer protection against fraud</li>
                                <li>Free dispute resolution service</li>
                            </ul>
                            <div class="mt-3 p-2 bg-white border-start border-success border-3">
                                <p class="extra-small mb-1 text-muted"><strong>How it works:</strong></p>
                                <ol class="extra-small mb-0 ps-3">
                                    <li>Pay now → Money held in escrow</li>
                                    <li>Seller ships your order</li>
                                    <li>You receive & confirm delivery</li>
                                    <li>Seller receives payment</li>
                                </ol>
                            </div>
                        </div>
                    </div>
                </div>

                
                <div class="p-3 border-bottom">
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="payment_method" id="creditCard" value="card">
                        <label class="form-check-label fw-bold small" for="creditCard">Credit or Debit Card (Direct)</label>
                    </div>
                    <div id="cardDetails" class="mt-4 px-3" style="display: none;">
                        <div class="mb-3">
                            <label class="form-label x-small fw-bold text-muted">Card Number</label>
                            <input type="text" class="form-control bg-light border-0" id="cardNumber" placeholder="0000 0000 0000 0000">
                        </div>
                        <div class="row g-3">
                            <div class="col-6">
                                <label class="form-label x-small fw-bold text-muted">Expiry</label>
                                <input type="text" class="form-control bg-light border-0" id="expiryDate" placeholder="MM/YY">
                            </div>
                            <div class="col-6">
                                <label class="form-label x-small fw-bold text-muted">CVV</label>
                                <input type="text" class="form-control bg-light border-0" id="cvv" placeholder="000">
                            </div>
                        </div>
                    </div>
                </div>
                <div class="p-3">
            <div class="form-check">
                <input class="form-check-input" type="radio" name="payment_method" id="walletPayment" value="wallet">
                <label class="form-check-label fw-bold small" for="walletPayment">
                    <ion-icon name="wallet" class="text-primary align-middle me-1"></ion-icon>
                    Pay with Wallet
                </label>
            </div>
            <div id="walletDetails" class="mt-3 px-3" style="display: none;">
                {% if user.is_authenticated %}
                <p class="x-small text-muted mb-2">
                    Available Balance: <strong class="text-success">₦{{ user.wallet.balance|floatformat:2|intcomma }}</strong>
                </p>
                {% if user.wallet.balance < cart_total %}
                <div class="alert alert-warning border-0 mb-0 x-small">
                    Insufficient balance. Please <a href="{% url 'wallet_top_up' %}">top up your wallet</a>.
                </div>
                {% endif %}
                {% endif %}
            </div>
        </div>
                <!-- Bank Transfer Option -->
                <div class="p-3">
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="payment_method" id="bankTransfer" value="bank">
                        <label class="form-check-label fw-bold small text-muted" for="bankTransfer">Direct Bank Transfer</label>
                    </div>
                </div>
            </div>
        </div>
      </div>

      <div class="col-lg-5">
        <div class="p-4 border bg-white position-sticky" style="top: 120px;">
          <h5 class="fw-bold text-uppercase mb-4 border-bottom pb-3" style="font-size: 13px; letter-spacing: 1px;">Marketplace Order Summary</h5>
          
          <div class="mb-4" style="max-height: 200px; overflow-y: auto;">
            {% for item in cart_items %}
            <div class="d-flex align-items-center mb-3">
                <div class="border p-1 me-3" style="width: 50px; height: 50px;">
                    {% if item.product.get_primary_image %}
                        <img src="{{ item.product.get_primary_image }}" class="w-100 h-100 object-fit-cover" alt="item">
                    {% else %}
                        <div class="w-100 h-100 bg-light d-flex align-items-center justify-content-center"><ion-icon name="image-outline" class="x-small text-muted"></ion-icon></div>
                    {% endif %}
                </div>
                <div class="flex-grow-1">
                    <h6 class="mb-0 small fw-bold">{{ item.product.name|truncatechars:30 }}</h6>
                    <span class="x-small text-muted text-uppercase">Qty: {{ item.quantity }}</span>
                </div>
                <span class="small fw-bold">{{ item.total_price }}</span>
            </div>
            {% endfor %}
          </div>

          <div class="d-flex justify-content-between mb-2">
            <span class="text-muted small">Subtotal</span>
            <span class="fw-bold small">{{ cart_subtotal }}</span>
          </div>
          <div class="d-flex justify-content-between mb-2">
            <span class="text-muted small">Logistics</span>
            <span class="fw-bold small text-success" id="shippingCost">FREE</span>
          </div>
          <div class="d-flex justify-content-between mb-2">
            <span class="text-muted small">VAT (7.5%)</span>
            <span class="fw-bold small">{{ cart_tax }}</span>
          </div>
          
          <!-- Escrow Fee Display -->
          <div class="d-flex justify-content-between mb-4 border-bottom pb-3" id="escrowFeeRow">
            <span class="text-muted small">
                <ion-icon name="shield-checkmark" class="text-success align-middle"></ion-icon>
                Escrow Protection Fee (2.5%)
            </span>
            <span class="fw-bold small text-success" id="escrowFee">₦0</span>
          </div>

          <div class="d-flex justify-content-between align-items-center mb-4">
            <span class="h6 fw-bold mb-0 text-uppercase">Total to Pay</span>
            <span class="h4 fw-bold mb-0 text-success" id="totalAmount">{{ cart_total }}</span>
          </div>

          <button type="submit" class="btn btn-lg w-100 py-3 mb-3 border-0 text-white text-uppercase fw-bold" id="submitBtn" style="background-color: var(--primary-green); font-size: 13px; letter-spacing: 1px;">
            <ion-icon name="shield-checkmark" class="align-middle me-1"></ion-icon>
            Pay Securely with Escrow
          </button>

          <div class="form-check mb-4">
            <input class="form-check-input" type="checkbox" id="termsCheck" required>
            <label class="form-check-label x-small text-muted fw-bold" for="termsCheck">
                I agree to the <a href="#" style="color: var(--primary-green);">Terms & Privacy Policy</a>
            </label>
          </div>

          <div class="row text-center g-2 pt-3 border-top mt-3 opacity-75">
            <div class="col-4">
                <ion-icon name="shield-checkmark-outline" class="fs-4 text-success"></ion-icon>
                <p class="extra-small fw-bold text-uppercase mt-1 m-0">Secure</p>
            </div>
            <div class="col-4 border-start border-end">
                <ion-icon name="lock-closed-outline" class="fs-4 text-success"></ion-icon>
                <p class="extra-small fw-bold text-uppercase mt-1 m-0">Private</p>
            </div>
            <div class="col-4">
                <ion-icon name="headset-outline" class="fs-4 text-success"></ion-icon>
                <p class="extra-small fw-bold text-uppercase mt-1 m-0">Support</p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </form>
</div>

<style>
  /* Base Afrimart Reset */
  .card, .btn, .form-control, .form-select, .input-group-text, .form-check-input, .method-select-card, .border { border-radius: 0 !important; }
  .x-small { font-size: 11px; }
  .extra-small { font-size: 10px; }
  
  .form-control {
    font-size: 15px !important;
  }

  .form-select {
    font-size: 15px !important;
  }

  .form-control:focus, .form-select:focus {
    border-color: var(--primary-green);
    box-shadow: none;
    background: #fff !important;
  }

  .form-check-input:checked {
    background-color: var(--primary-green);
    border-color: var(--primary-green);
  }

  .method-select-card {
    transition: 0.2s;
    background-color: #fff;
  }
  .method-select-card:hover { border-color: var(--primary-green); background-color: #fcfcfc; }
  
  /* Layout Spacing */
  main { padding-top: 20px; }
  .cursor-pointer { cursor: pointer; }
</style>

<script>

  const cartTotal = parseFloat('{{ cart_total|cut:"₦"|cut:"," }}') || 0;
  const escrowFeeAmount = (cartTotal * 0.025).toFixed(2);
  const totalWithEscrow = (cartTotal + parseFloat(escrowFeeAmount)).toFixed(2);

  // Payment method toggle logic
  document.querySelectorAll('input[name="payment_method"]').forEach(radio => {
    radio.addEventListener('change', function() {
      const cardDetails = document.getElementById('cardDetails');
      const escrowDetails = document.getElementById('escrowDetails');
      const escrowFeeRow = document.getElementById('escrowFeeRow');
      const submitBtn = document.getElementById('submitBtn');
      const totalAmountDisplay = document.getElementById('totalAmount');
      const escrowFeeDisplay = document.getElementById('escrowFee');
      const walletDetails = document.getElementById('walletDetails');

      // Hide all detail sections first
      cardDetails.style.display = 'none';
      escrowDetails.style.display = 'none';
      
      // Show relevant section and update totals
      if (this.value === 'card') {
        cardDetails.style.display = 'block';
        escrowFeeRow.style.display = 'none';
        submitBtn.innerHTML = 'Confirm Order & Pay Now';
        totalAmountDisplay.textContent = '₦' + cartTotal.toLocaleString();
      } else if (this.value === 'escrow') {
        escrowDetails.style.display = 'block';
        escrowFeeRow.style.display = 'flex';
        submitBtn.innerHTML = '<ion-icon name="shield-checkmark" class="align-middle me-1"></ion-icon> Pay Securely with Escrow';
        escrowFeeDisplay.textContent = '₦' + parseFloat(escrowFeeAmount).toLocaleString();
        totalAmountDisplay.textContent = '₦' + parseFloat(totalWithEscrow).toLocaleString();
      } else if (this.value === 'bank') {
        escrowFeeRow.style.display = 'none';
        submitBtn.innerHTML = 'Confirm Order & Pay';
        totalAmountDisplay.textContent = '₦' + cartTotal.toLocaleString();
      }else if(this.value ==='wallet' ){
          walletDetails.style.display = 'block';
          escrowFeeRow.style.display = 'none';
          submitBtn.innerHTML = '<ion-icon name="wallet" class="align-middle me-1"></ion-icon> Pay with Wallet';
          totalAmountDisplay.textContent = '₦' + baseTotal.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2});
      }


    });
  });

  // Trigger change on page load to set initial state
  document.querySelector('input[name="payment_method"]:checked').dispatchEvent(new Event('change'));

  // Basic formatting for card inputs
  document.getElementById('cardNumber')?.addEventListener('input', (e) => {
    e.target.value = e.target.value.replace(/\D/g, '').replace(/(.{4})/g, '$1 ').trim();
  });
  
  document.getElementById('expiryDate')?.addEventListener('input', (e) => {
    let val = e.target.value.replace(/\D/g, '');
    if (val.length >= 2) e.target.value = val.slice(0, 2) + '/' + val.slice(2, 4);
  });
</script>

{% endblock %}
