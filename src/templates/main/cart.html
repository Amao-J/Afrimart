{% extends 'base.html' %}
{% load humanize %}
{% load static %}
{% load currency_tags %}

{% block title %}Shopping Cart - Afrimart{% endblock %}

{% block content %}

<div class="container my-5 py-3">
  <nav aria-label="breadcrumb" class="mb-4">
    <ol class="breadcrumb mb-0">
      <li class="breadcrumb-item"><a href="{% url 'home' %}" class="text-decoration-none text-muted small">Home</a></li>
      <li class="breadcrumb-item active small" aria-current="page">Shopping Cart</li>
    </ol>
  </nav>

  <div class="border-bottom pb-3 mb-5">
    <h1 class="fw-bold h2 mb-0" style="letter-spacing: -1px;">Shopping Cart</h1>
    <p class="text-muted small mb-0">You have {{ cart_count }} items in your marketplace bag</p>
  </div>

  {% if cart_items %}
  <div class="row g-5">
    <div class="col-lg-8">
      <div class="d-none d-md-flex py-3 border-bottom text-uppercase fw-bold" style="font-size: 11px; letter-spacing: 1px; color: #999;">
        <div class="col-md-6">Product Details</div>
        <div class="col-md-2 text-center">Unit Price</div>
        <div class="col-md-2 text-center">Quantity</div>
        <div class="col-md-2 text-end pe-3">Subtotal</div>
      </div>

      {% for item in cart_items %}
      <div class="cart-item py-4 border-bottom position-relative">
        <div class="row align-items-center">
          <div class="col-md-6">
            <div class="d-flex align-items-center">
              <div class="me-4 border" style="width: 120px; height: 140px; background: #fcfcfc;">
                <a href="/product/{{ item.product.id }}/">
                  {% if item.product.get_primary_image %}
                    <img src="{{ item.product.get_primary_image }}" alt="{{ item.product.name }}" class="w-100 h-100" style="object-fit: cover;">
                  {% else %}
                    <div class="w-100 h-100 d-flex align-items-center justify-content-center text-muted">
                      <ion-icon name="image-outline" style="font-size: 32px;"></ion-icon>
                    </div>
                  {% endif %}
                </a>
              </div>
              
              <div class="flex-grow-1">
                <span class="text-success text-uppercase fw-bold mb-1 d-block" style="font-size: 10px; letter-spacing: 1px;">{{ item.product.category.name }}</span>
                <h6 class="fw-bold mb-1">
                  <a href="/product/{{ item.product.id }}/" class="text-decoration-none text-dark">{{ item.product.name }}</a>
                </h6>
                <div class="d-flex align-items-center gap-2 mb-3">
                    {% if item.product.stock > 0 %}
                        <span class="x-small text-success fw-bold d-flex align-items-center"><div class="bg-success me-1" style="width:6px; height:6px;"></div> In Stock</span>
                    {% else %}
                        <span class="x-small text-danger fw-bold d-flex align-items-center"><div class="bg-danger me-1" style="width:6px; height:6px;"></div> Out of Stock</span>
                    {% endif %}
                </div>
                
                <form method="POST" action="" class="d-none d-md-block">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-link p-0 text-muted x-small fw-bold text-uppercase text-decoration-none hover-danger">
                        <ion-icon name="close-outline" class="align-middle"></ion-icon> Remove Item
                    </button>
                </form>
              </div>
            </div>
          </div>

          <div class="col-md-2 text-center d-none d-md-block">
            <span class="fw-bold">{{ item.product.converted_price }}</span>
          </div>

          <div class="col-md-2">
            <div class="d-flex align-items-center justify-content-center mt-3 mt-md-0 border p-1 bg-light" style="max-width: 120px; margin: 0 auto;">
              <form method="POST" action="" class="d-flex align-items-center w-100">
                {% csrf_token %}
                <button type="submit" name="action" value="decrease" class="btn btn-sm border-0 px-2 shadow-none"><ion-icon name="remove-outline"></ion-icon></button>
                <input type="number" name="quantity" value="{{ item.quantity }}" class="form-control form-control-sm border-0 bg-transparent text-center fw-bold px-0 shadow-none" readonly>
                <button type="submit" name="action" value="increase" class="btn btn-sm border-0 px-2 shadow-none"><ion-icon name="add-outline"></ion-icon></button>
              </form>
            </div>
          </div>

          <div class="col-md-2 text-end pe-3">
            <p class="mb-0 fw-bold h6 mt-2 mt-md-0 text-success">{{ item.total_price }}</p>
          </div>
        </div>
        
        <form method="POST" action="" class="d-md-none position-absolute top-0 end-0 mt-3 me-2">
            {% csrf_token %}
            <button type="submit" class="btn btn-sm text-danger border-0 px-2"><ion-icon name="trash-outline" size="small"></ion-icon></button>
        </form>
      </div>
      {% endfor %}

      <div class="mt-5 pt-4 border-top">
        <h6 class="fw-bold text-uppercase mb-3" style="font-size: 11px; letter-spacing: 1px;">Marketplace Coupon</h6>
        <form method="POST" action="" class="d-flex gap-2" style="max-width: 450px;">
          {% csrf_token %}
          <input type="text" name="coupon_code" class="form-control form-control-lg bg-light border-0" placeholder="Enter code" style="font-size: 14px;">
          <button type="submit" class="btn btn-dark px-4 text-uppercase fw-bold" style="font-size: 12px; letter-spacing: 1px;">Apply</button>
        </form>
      </div>
    </div>

    <div class="col-lg-4">
      <div class="p-4 border bg-white position-sticky" style="top: 120px;">
        <h5 class="fw-bold text-uppercase mb-4 border-bottom pb-3" style="font-size: 13px; letter-spacing: 1px;">Order Summary</h5>
        
        <div class="d-flex justify-content-between mb-3">
          <span class="text-muted small">Marketplace Subtotal</span>
          <span class="fw-bold small">{{ cart_subtotal }}</span>
        </div>

        <div class="d-flex justify-content-between mb-3">
          <span class="text-muted small">Logistics & Shipping</span>
          <span class="text-success fw-bold small text-uppercase">Free</span>
        </div>

        {% if discount_amount %}
        <div class="d-flex justify-content-between mb-3">
          <span class="text-muted small text-success">Discount Applied</span>
          <span class="text-success fw-bold small">-{{ discount_amount }}</span>
        </div>
        {% endif %}

        <div class="d-flex justify-content-between mb-4 border-bottom pb-3">
          <span class="text-muted small">VAT (7.5%)</span>
          <span class="fw-bold small">{{ cart_tax }}</span>
        </div>

        <div class="d-flex justify-content-between align-items-center mb-5">
          <span class="h6 fw-bold mb-0 text-uppercase" style="letter-spacing: 1px;">Total Amount</span>
          <span class="h4 fw-bold mb-0 text-success">{{ cart_total }}</span>
        </div>

        <a href="{% url 'checkout' %}" class="btn btn-lg w-100 py-3 mb-3 border-0 text-white text-uppercase fw-bold" style="background-color: var(--primary-green); font-size: 13px; letter-spacing: 1px;">
          Proceed to Checkout <ion-icon name="arrow-forward-outline" class="ms-1 align-middle"></ion-icon>
        </a>

        <a href="{% url 'product_list' %}" class="btn btn-outline-dark btn-lg w-100 py-3 text-uppercase fw-bold" style="font-size: 11px; letter-spacing: 1px;">
          Continue Shopping
        </a>

        <div class="mt-5 border-top pt-4">
            <div class="d-flex align-items-center mb-3">
                <ion-icon name="shield-checkmark-outline" class="text-success fs-5 me-3"></ion-icon>
                <span class="x-small fw-bold text-uppercase text-muted" style="letter-spacing: 0.5px;">100% Secure Checkout</span>
            </div>
            <div class="d-flex align-items-center mb-3">
                <ion-icon name="airplane-outline" class="text-success fs-5 me-3"></ion-icon>
                <span class="x-small fw-bold text-uppercase text-muted" style="letter-spacing: 0.5px;">Verified Artisan Shipping</span>
            </div>
            <div class="d-flex align-items-center">
                <ion-icon name="sync-outline" class="text-success fs-5 me-3"></ion-icon>
                <span class="x-small fw-bold text-uppercase text-muted" style="letter-spacing: 0.5px;">30-Day Escrow Protection</span>
            </div>
        </div>
      </div>
    </div>
  </div>

  {% else %}
  <div class="text-center py-5 my-5 border">
    <div class="mb-4">
      <ion-icon name="bag-handle-outline" style="font-size: 80px; color: #eee;"></ion-icon>
    </div>
    <h2 class="fw-bold mb-2">Marketplace Bag is Empty</h2>
    <p class="text-muted small mb-4">Discover the finest authentic African products to get started.</p>
    <a href="{% url 'product_list' %}" class="btn btn-lg px-5 py-3 border-0 text-white text-uppercase fw-bold" style="background-color: var(--primary-green); font-size: 13px; letter-spacing: 1px;">
      Explore Marketplace
    </a>
  </div>
  {% endif %}
</div>

<style>
  /* Forced Afrimart UI Overrides */
  .card, .btn, .form-control, .badge, .breadcrumb-item, .alert { border-radius: 0 !important; }
  .x-small { font-size: 11px; }
  
  .cart-item { transition: all 0.3s ease; }
  .cart-item:hover { border-color: var(--primary-green) !important; background-color: #fcfcfc; }

  .hover-danger:hover { color: #dc3545 !important; }

  /* Removing spin buttons for quantity input */
  input[type="number"]::-webkit-inner-spin-button,
  input[type="number"]::-webkit-outer-spin-button {
    -webkit-appearance: none;
    margin: 0;
  }
  input[type="number"] { -moz-appearance: textfield; }
  
  .form-control:focus {
    border-color: var(--primary-green);
    box-shadow: none;
    background: #fff !important;
  }
</style>

{% endblock %}